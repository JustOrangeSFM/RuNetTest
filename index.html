<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RuNetTest — Проверка интернет-соединения</title>
<style>
  /* Темы */
  :root {
    --accent-color: #4a90e2;
    --accent-glow: #4a90e233;
    --btn-radius: 10px;
  }
  body.dark {
    --bg-color: #12151c;
    --text-color: #a8b0c0;
    --border-color: #2a3346;
    --btn-bg: #3b5070;
    --btn-bg-hover: #2f405a;
    --btn-text: #c5d0e0;
    --log-bg: #242b3d;
    --circle-bg: radial-gradient(circle at center, #1b2029 40%, #12151c 95%);
    --chart-bg: #1b2029;
    --log-shadow: inset 0 0 10px var(--accent-glow);
  }
  body.light {
    --bg-color: #fefefe;
    --text-color: #3a3a3a;
    --border-color: #ccc;
    --btn-bg: #8ab4f8;
    --btn-bg-hover: #6a94e6;
    --btn-text: #fff;
    --log-bg: #e8ebf7;
    --circle-bg: radial-gradient(circle at center, #dbe1f0 40%, #fefefe 95%);
    --chart-bg: #dbe1f0;
    --log-shadow: inset 0 0 10px #a0b4ff33;
  }

  body {
    background: var(--bg-color);
    color: var(--text-color);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    padding: 40px 20px 60px;
    text-align: center;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    user-select: none;
    transition: background-color 0.4s, color 0.4s, transform 1s ease, opacity 1s ease;
  }
  h1 {
    margin-bottom: 10px;
    font-weight: 700;
    font-size: clamp(1.8rem, 4vw, 2.8rem);
    color: var(--accent-color);
    text-shadow: 0 0 6px var(--accent-glow);
  }

  .circle {
    width: clamp(180px, 45vw, 260px);
    height: clamp(180px, 45vw, 260px);
    background: var(--circle-bg);
    border: 8px solid var(--border-color);
    border-radius: 50%;
    margin: 20px auto 30px;
    box-shadow: 0 0 10px var(--accent-glow);
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    position: relative;
  }

  .value {
    font-size: clamp(2.4rem, 8vw, 4.5rem);
    color: var(--accent-color);
    font-weight: 900;
    text-shadow: 0 0 3px var(--accent-glow);
    transition: color 0.3s ease;
  }

  .unit {
    font-size: clamp(0.9rem, 2vw, 1.3rem);
    color: #8092aa;
    margin-top: 4px;
    font-weight: 600;
    user-select: none;
    display: inline-flex;
    align-items: center;
  }

  .unit button {
    margin-left: 8px;
    background: var(--btn-bg);
    border: none;
    border-radius: var(--btn-radius);
    padding: 3px 10px;
    color: var(--btn-text);
    font-weight: 600;
    cursor: pointer;
    font-size: 0.9rem;
    user-select: none;
    transition: background-color 0.3s ease;
  }
  .unit button:hover {
    background: var(--btn-bg-hover);
  }

  .speed-mb {
    font-size: clamp(0.8rem, 1.7vw, 1.1rem);
    color: #6587c1;
    margin-top: 2px;
    font-weight: 500;
    user-select: none;
  }

  .results {
    margin: 0 auto 40px;
    max-width: 480px;
    font-size: clamp(1rem, 2vw, 1.3rem);
    line-height: 1.8em;
    text-align: left;
    color: var(--text-color);
  }
  .results div {
    margin-bottom: 12px;
  }
  strong {
    color: var(--accent-color);
  }

  button, #toggleIpBtn, #toggleLangBtn, #toggleThemeBtn {
    margin-top: 10px;
    padding: 12px 40px;
    font-size: clamp(1rem, 2vw, 1.2rem);
    background: var(--btn-bg);
    border: none;
    border-radius: var(--btn-radius);
    color: var(--btn-text);
    cursor: pointer;
    font-weight: 700;
    transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
    box-shadow: 0 0 12px var(--accent-glow);
    user-select: none;
  }
  button:hover:not(:disabled), #toggleIpBtn:hover:not(:disabled), #toggleLangBtn:hover:not(:disabled), #toggleThemeBtn:hover:not(:disabled) {
    background: var(--btn-bg-hover);
    transform: scale(1.05);
    box-shadow: 0 0 18px var(--accent-glow);
  }
  button:disabled {
    background: var(--border-color);
    cursor: not-allowed;
    box-shadow: none;
    color: #7a8594;
  }

  #toggleIpBtn, #toggleLangBtn, #toggleThemeBtn {
    font-size: 0.85rem;
    padding: 6px 14px;
    margin-left: 12px;
    vertical-align: middle;
    border-radius: var(--btn-radius);
  }

  canvas {
    margin: 0 auto 25px;
    display: block;
    background: var(--chart-bg);
    border-radius: 14px;
    max-width: 480px;
    width: 100%;
    height: 180px;
    box-shadow: 0 0 12px var(--accent-glow);
  }

  #log {
    max-width: 480px;
    margin: 0 auto;
    padding: 18px;
    background: var(--log-bg);
    border-radius: 14px;
    height: 140px;
    overflow-y: auto;
    font-size: 0.9rem;
    color: var(--accent-color);
    font-family: 'Courier New', Courier, monospace;
    text-align: left;
    white-space: pre-wrap;
    box-shadow: var(--log-shadow);
    user-select: text;
  }
  #log .start, #log .end {
    font-weight: 700;
    padding: 4px 6px;
    border-radius: 6px;
    margin-bottom: 6px;
    display: inline-block;
  }
  #log .start {
    color: #2e7d32;
    background-color: #c8e6c9;
  }
  body.dark #log .start {
    background-color: #1b391b;
    color: #76d275;
  }
  #log .end {
    color: #c62828;
    background-color: #ffcdd2;
  }
  body.dark #log .end {
    background-color: #3f1a1a;
    color: #f88a8a;
  }

  .recommendation {
    display: none;
    max-width: 480px;
    margin: 20px auto 0;
    padding: 18px 24px;
    background: var(--btn-bg);
    color: var(--btn-text);
    font-size: 1.1rem;
    border-radius: var(--btn-radius);
    box-shadow: 0 0 20px var(--accent-glow);
    user-select: none;
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 0.7s ease, transform 0.7s ease;
  }
  .recommendation.show {
    display: block;
    opacity: 1;
    transform: translateY(0);
  }

  /* Анимация появления */
  body > * {
    opacity: 0;
    transform: translateY(15px);
    animation: fadeUp 0.7s ease forwards;
  }
  body > h1 { animation-delay: 0.15s; }
  body > .circle { animation-delay: 0.35s; }
  body > .results { animation-delay: 0.55s; }
  body > button { animation-delay: 0.75s; }
  body > canvas { animation-delay: 0.95s; }
  body > #log { animation-delay: 1.15s; }

  @keyframes fadeUp {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Плавный подъем сайта при завершении теста */
  body.finished {
    transform: translateY(-25px);
    opacity: 0.9;
  }

  /* Адаптив */
  @media (max-width: 520px) {
    body {
      padding: 30px 15px 40px;
    }
    .results {
      font-size: 1rem;
    }
    button, #toggleIpBtn, #toggleLangBtn, #toggleThemeBtn {
      padding: 10px 24px;
      font-size: 1rem;
    }
    #log {
      height: 120px;
      font-size: 0.85rem;
    }
    .recommendation {
      font-size: 1rem;
      padding: 14px 18px;
    }
  }
</style>
</head>
<body>

<h1 id="title">RuNetTest — Проверка интернет-соединения</h1>

<div class="circle" aria-live="polite" aria-atomic="true">
  <div class="value" id="speed">0</div>
  <div class="unit" id="speed-unit">
    Мбит/с
    <button id="toggleUnitBtn" title="Переключить единицы">⇄</button>
  </div>
  <div class="speed-mb" id="speed-mb"></div>
</div>

<div class="results" aria-live="polite" aria-atomic="true">
  <div>
    <strong id="ip-label">Ваш IP:</strong> 
    <span id="ip">…</span>
    <button id="toggleIpBtn" onclick="toggleIP()">Скрыть IP</button>
  </div>
  <div><strong id="ping-label">Пинг (задержка):</strong> <span id="ping">…</span></div>
  <div><strong id="download-label">Скорость скачивания (download):</strong> <span id="download">…</span></div>
</div>

<button id="startBtn" onclick="startTest()">Начать тест</button>
<button id="toggleThemeBtn">Переключить тему</button>
<button id="toggleLangBtn">English</button>

<canvas id="chart" aria-label="График скорости и пинга" role="img"></canvas>

<div id="log" aria-live="polite" aria-atomic="false"></div>

<div class="recommendation" id="recommendation" aria-live="polite" aria-atomic="true"></div>

<script>
  // --- Переменные ---
  const logEl = document.getElementById("log");
  const chart = document.getElementById("chart");
  const ctx = chart.getContext("2d");
  const ipEl = document.getElementById("ip");
  const toggleIpBtn = document.getElementById("toggleIpBtn");
  const speedUnitEl = document.getElementById("speed-unit");
  const speedMbEl = document.getElementById("speed-mb");
  const startBtn = document.getElementById("startBtn");
  const recommendationEl = document.getElementById("recommendation");
  const toggleThemeBtn = document.getElementById("toggleThemeBtn");
  const toggleLangBtn = document.getElementById("toggleLangBtn");

  const ipLabel = document.getElementById("ip-label");
  const pingLabel = document.getElementById("ping-label");
  const downloadLabel = document.getElementById("download-label");
  const titleEl = document.getElementById("title");

  chart.width = chart.clientWidth * devicePixelRatio;
  chart.height = chart.clientHeight * devicePixelRatio;
  ctx.scale(devicePixelRatio, devicePixelRatio);

  const pingPoints = [];
  const downloadPoints = [];
  const maxPoints = 30;

  let isRunning = false;
  let ipHidden = false;
  let useMegaBytes = false; // false = Мбит/с, true = МБ/с
  let lang = 'ru'; // ru или en
  let lastSpeedBps = 0;
  let lastPingMs = 0;
  let lastDownloadBps = 0;

  // --- Тексты для переводов ---
  const texts = {
    ru: {
      title: "RuNetTest — Проверка интернет-соединения",
      startTest: "Начать тест",
      hideIP: "Скрыть IP",
      showIP: "Показать IP",
      ipLabel: "Ваш IP:",
      pingLabel: "Пинг (задержка):",
      downloadLabel: "Скорость скачивания (download):",
      toggleUnit: "⇄",
      toggleTheme: "Переключить тему",
      toggleLang: "English",
      testStarted: "Тест начат",
      testFinished: "Тест завершён",
      recommendationGood: "Ваш интернет работает нормально. Для онлайн-игр рекомендуется пинг ниже 50 мс и скорость выше 10 Мбит/с.",
      recommendationPingHigh: "Высокий пинг! Для комфортной игры в онлайн лучше использовать проводное соединение или серверы ближе к вам.",
      recommendationSpeedLow: "Низкая скорость. Для потокового видео и игр рекомендуем улучшить подключение.",
      recommendationIPHidden: "IP скрыт — тест проходит анонимно."
    },
    en: {
      title: "RuNetTest — Internet Connection Test",
      startTest: "Start Test",
      hideIP: "Hide IP",
      showIP: "Show IP",
      ipLabel: "Your IP:",
      pingLabel: "Ping (latency):",
      downloadLabel: "Download speed:",
      toggleUnit: "⇄",
      toggleTheme: "Toggle Theme",
      toggleLang: "Русский",
      testStarted: "Test started",
      testFinished: "Test finished",
      recommendationGood: "Your internet is working fine. For online games, ping below 50 ms and speed above 10 Mbps is recommended.",
      recommendationPingHigh: "High ping! For smoother online gaming, consider wired connection or closer servers.",
      recommendationSpeedLow: "Low speed. For video streaming and gaming, improving your connection is advised.",
      recommendationIPHidden: "IP is hidden — test runs anonymously."
    }
  };

  // --- Функции переключения языка ---
  function applyLang(newLang) {
    lang = newLang;
    localStorage.setItem('lang', lang);

    titleEl.textContent = texts[lang].title;
    startBtn.textContent = texts[lang].startTest;
    toggleIpBtn.textContent = ipHidden ? texts[lang].showIP : texts[lang].hideIP;
    ipLabel.textContent = texts[lang].ipLabel;
    pingLabel.textContent = texts[lang].pingLabel;
    downloadLabel.textContent = texts[lang].downloadLabel;
    document.getElementById("toggleUnitBtn").title = texts[lang].toggleUnit;
    toggleThemeBtn.textContent = texts[lang].toggleTheme;
    toggleLangBtn.textContent = texts[lang].toggleLang;
  }
  toggleLangBtn.onclick = () => {
    applyLang(lang === 'ru' ? 'en' : 'ru');
  };
  const savedLang = localStorage.getItem('lang');
  if(savedLang) applyLang(savedLang);
  else applyLang('ru');

  // --- Тема ---
  function applyTheme(theme) {
    document.body.classList.remove("dark", "light");
    document.body.classList.remove("finished");
    document.body.classList.add(theme);
    localStorage.setItem("theme", theme);
  }
  function toggleTheme() {
    if (document.body.classList.contains("dark")) {
      applyTheme("light");
    } else {
      applyTheme("dark");
    }
  }
  toggleThemeBtn.onclick = toggleTheme;
  const savedTheme = localStorage.getItem("theme");
  if (savedTheme) {
    applyTheme(savedTheme);
  } else {
    const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
    applyTheme(prefersDark ? "dark" : "light");
  }

  // --- Единицы измерения ---
  document.getElementById("toggleUnitBtn").onclick = () => {
    useMegaBytes = !useMegaBytes;
    updateResults(lastSpeedBps, lastPingMs, lastDownloadBps);
  };

  // --- Лог ---
  function log(text, type = "") {
  const now = new Date().toLocaleTimeString();
  const line = document.createElement("div");
  line.textContent = `[${now}] ${text}`;
  if (type === "start") line.classList.add("start");
  if (type === "end") line.classList.add("end");
  logEl.appendChild(line);
  logEl.scrollTop = logEl.scrollHeight;
}

// Формат скорости (Мбит/с или МБ/с)
function formatSpeed(bitsPerSecond) {
  if (typeof bitsPerSecond !== "number" || bitsPerSecond <= 0) return "0";
  if (!useMegaBytes) { // Мбит/с
    if (bitsPerSecond >= 1e9) return (bitsPerSecond / 1e9).toFixed(2) + " Гбит/с";
    if (bitsPerSecond >= 1e6) return (bitsPerSecond / 1e6).toFixed(2) + " Мбит/с";
    if (bitsPerSecond >= 1e3) return (bitsPerSecond / 1e3).toFixed(2) + " Кбит/с";
    return bitsPerSecond.toFixed(2) + " бит/с";
  } else { // МБ/с
    const bytesPerSecond = bitsPerSecond / 8;
    if (bytesPerSecond >= 1e6) return (bytesPerSecond / 1e6).toFixed(2) + " МБ/с";
    if (bytesPerSecond >= 1e3) return (bytesPerSecond / 1e3).toFixed(2) + " КБ/с";
    return bytesPerSecond.toFixed(2) + " Б/с";
  }
}

// Обновление результатов на экране
function updateResults(speedBps, pingMs, downloadBps) {
  lastSpeedBps = speedBps;
  lastPingMs = pingMs;
  lastDownloadBps = downloadBps;

  const speedStr = formatSpeed(speedBps);
  const downloadStr = formatSpeed(downloadBps);

  document.getElementById("speed").textContent = speedStr.split(" ")[0];
  speedUnitEl.childNodes[0].textContent = speedStr.replace(/[0-9.,\s]/g, '').trim() + " ";
  document.getElementById("download").textContent = downloadStr;
  document.getElementById("ping").textContent = pingMs ? `${pingMs.toFixed(1)} ms` : "…";

  // Также внизу выводим детальную скорость (если нужно)
  speedMbEl.textContent = useMegaBytes ? `(${speedStr})` : "";
}

// Получение IP (если не скрыт)
async function getIP() {
  if (ipHidden) {
    ipEl.textContent = texts[lang].recommendationIPHidden;
    log(texts[lang].recommendationIPHidden);
    return;
  }
  try {
    const res = await fetch('https://api64.ipify.org?format=json');
    const data = await res.json();
    ipEl.textContent = data.ip;
    log(`IP ${data.ip} получен / IP ${data.ip} received`);
  } catch {
    ipEl.textContent = lang === 'ru' ? "Не удалось получить IP" : "Failed to get IP";
    log(lang === 'ru' ? "Ошибка при получении IP" : "Error fetching IP");
  }
}

// Переключение показа IP
function toggleIP() {
  ipHidden = !ipHidden;
  if (ipHidden) {
    ipEl.textContent = texts[lang].recommendationIPHidden;
    toggleIpBtn.textContent = texts[lang].showIP;
  } else {
    toggleIpBtn.textContent = texts[lang].hideIP;
    getIP();
  }
}

// Функция, рисующая график пинга и скорости
function drawChart() {
  ctx.clearRect(0, 0, chart.width, chart.height);
  const w = chart.clientWidth;
  const h = chart.clientHeight;
  const margin = 30;

  // Ось Y (от 0 до макс скорости/пинга с запасом)
  const maxSpeed = Math.max(...downloadPoints, 1);
  const maxPing = Math.max(...pingPoints, 1);
  const maxY = Math.max(maxSpeed, maxPing) * 1.2;

  ctx.lineWidth = 2;
  ctx.font = '12px Courier New';
  ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--accent-color');

  // Рисуем ось Y
  ctx.beginPath();
  ctx.moveTo(margin, margin / 2);
  ctx.lineTo(margin, h - margin);
  ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--accent-color');
  ctx.stroke();

  // Рисуем ось X
  ctx.beginPath();
  ctx.moveTo(margin, h - margin);
  ctx.lineTo(w - margin, h - margin);
  ctx.stroke();

  // Рисуем пинг (красным)
  ctx.strokeStyle = "#c62828";
  ctx.beginPath();
  pingPoints.forEach((v, i) => {
    const x = margin + (i / maxPoints) * (w - margin * 2);
    const y = h - margin - (v / maxY) * (h - margin * 2);
    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  });
  ctx.stroke();

  // Рисуем скорость (синим)
  ctx.strokeStyle = "#4a90e2";
  ctx.beginPath();
  downloadPoints.forEach((v, i) => {
    const x = margin + (i / maxPoints) * (w - margin * 2);
    const y = h - margin - (v / maxY) * (h - margin * 2);
    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  });
  ctx.stroke();

  // Легенда
  ctx.fillStyle = "#c62828";
  ctx.fillText(lang === 'ru' ? 'Пинг' : 'Ping', w - 70, margin);
  ctx.fillStyle = "#4a90e2";
  ctx.fillText(lang === 'ru' ? 'Скорость' : 'Speed', w - 70, margin + 15);
}

// Добавляем точки на график и обновляем его
function addPoints(ping, speed) {
  if (pingPoints.length >= maxPoints) pingPoints.shift();
  if (downloadPoints.length >= maxPoints) downloadPoints.shift();
  pingPoints.push(ping);
  downloadPoints.push(speed);
  drawChart();
}

// Генерация рекомендаций по результатам
function generateRecommendations(ping, speed) {
  let recText = "";

  if (ping > 100) recText += texts[lang].recommendationPingHigh + " ";
  if (speed < 10e6) recText += texts[lang].recommendationSpeedLow + " ";
  if (ping <= 100 && speed >= 10e6) recText += texts[lang].recommendationGood;

  recommendationEl.textContent = recText.trim();
  if(recText) recommendationEl.classList.add("show");
  else recommendationEl.classList.remove("show");
}

// Основной тест — имитация, так как реальный тест нужен сервер
async function startTest() {
  if (isRunning) return;
  isRunning = true;
  logEl.innerHTML = "";
  recommendationEl.classList.remove("show");
  document.body.classList.remove("finished");

  log(texts[lang].testStarted, "start");
  startBtn.disabled = true;

  getIP();

  pingPoints.length = 0;
  downloadPoints.length = 0;

  // Имитируем тест (пинг + скачивание)
  for(let i=0; i<maxPoints; i++) {
    if(!isRunning) break;
    // Пинг имитация: 20-150ms рандомно
    const pingSim = 20 + Math.random() * 130;
    // Скорость имитация: 5-50 Мбит/с (5e6 - 50e6 бит/с)
    const speedSim = (5 + Math.random() * 45) * 1e6;

    addPoints(pingSim, speedSim);
    updateResults(speedSim, pingSim, speedSim);

    await new Promise(r => setTimeout(r, 300));
  }

  isRunning = false;
  log(texts[lang].testFinished, "end");
  generateRecommendations(lastPingMs, lastSpeedBps);

  // Плавный подъём сайта при окончании
  document.body.classList.add("finished");
  startBtn.disabled = false;
}
</script>

</body>
</html>

