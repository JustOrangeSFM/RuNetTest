<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>RuNetTest — Проверка интернет-соединения</title>
  <style>
    /* СТИЛИ ОСТАВЛЕНЫ БЕЗ ИЗМЕНЕНИЙ (см. выше) */
    body {
      background: #0d1117;
      color: #eee;
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 40px 20px 60px;
      margin: 0;
    }
    h1 { margin-bottom: 10px; }
    .circle {
      width: 220px;
      height: 220px;
      background: radial-gradient(#111, #000);
      border: 8px solid #333;
      border-radius: 50%;
      margin: 20px auto;
      box-shadow: 0 0 15px #0ff;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    .value { font-size: 3em; color: #0ff; font-weight: bold; }
    .unit { font-size: 1.1em; color: #888; margin-top: 4px; }
    .speed-mb { font-size: 0.9em; color: #0aa; margin-top: 2px; }
    .results {
      margin-top: 30px;
      font-size: 1.25em;
      line-height: 1.8em;
      max-width: 480px;
      margin-left: auto;
      margin-right: auto;
      text-align: left;
    }
    .results div { margin-bottom: 10px; }
    .recommendation {
      margin-top: 30px;
      background: #111;
      padding: 20px;
      max-width: 480px;
      margin-left: auto;
      margin-right: auto;
      border-radius: 10px;
      color: #0ff;
      font-size: 1.1em;
      line-height: 1.5em;
    }
    button {
      margin-top: 35px;
      padding: 12px 40px;
      font-size: 1.2em;
      background: #0ff;
      border: none;
      border-radius: 6px;
      color: #000;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:hover:not(:disabled) {
      background: #00cccc;
    }
    button:disabled {
      background: #055757;
      cursor: not-allowed;
    }
    #toggleIpBtn {
      font-size: 0.8em;
      padding: 4px 8px;
      margin-left: 10px;
      vertical-align: middle;
      cursor: pointer;
      border-radius: 4px;
      background: #0ff;
      color: #000;
      border: none;
      transition: background-color 0.3s ease;
    }
    #toggleIpBtn:hover:not(:disabled) {
      background: #00cccc;
    }
    canvas {
      margin: 20px auto;
      display: block;
      background: #111;
      border-radius: 8px;
      max-width: 480px;
      width: 100%;
      height: 180px;
    }
    #log {
      max-width: 480px;
      margin: 10px auto 0;
      padding: 15px;
      background: #111;
      border-radius: 8px;
      height: 140px;
      overflow-y: auto;
      font-size: 0.9em;
      color: #0ff;
      font-family: monospace;
      text-align: left;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>

<h1>RuNetTest — Проверка интернет-соединения</h1>

<div class="circle" aria-live="polite" aria-atomic="true">
  <div class="value" id="speed">0</div>
  <div class="unit" id="speed-unit">Мбит/с</div>
  <div class="speed-mb" id="speed-mb"></div>
</div>

<div class="results" aria-live="polite" aria-atomic="true">
  <div>
    <strong>Ваш IP:</strong> 
    <span id="ip">…</span>
    <button id="toggleIpBtn" onclick="toggleIP()">Скрыть IP</button>
  </div>
  <div><strong>Пинг (задержка):</strong> <span id="ping">…</span></div>
  <div><strong>Скорость скачивания (download):</strong> <span id="download">…</span></div>
  <div><strong>Скорость отправки данных (upload):</strong> <span id="upload">…</span></div>
</div>

<div style="max-width: 480px; margin: 20px auto; text-align: left; color: #0ff;">
  <label style="display:flex; align-items:center; font-size:1.1em; cursor:pointer; user-select:none;">
    <input type="checkbox" id="useCustomUrls" style="vertical-align:middle; margin-right:8px;" />
    Использовать свои ссылки на файлы
  </label>
  <textarea id="customUrlsInput" placeholder="Вставьте сюда URL файлов, по одному в строке"
    style="width: 100%; height: 80px; display:none; background:#222; color:#0ff; border: 1px solid #0ff; border-radius:4px; padding:6px; font-family: monospace; margin-top:8px; resize: vertical;"></textarea>
</div>

<button id="startBtn" onclick="startTest()">Начать тест</button>

<canvas id="chart" aria-label="График скорости и пинга" role="img"></canvas>

<div id="log" aria-live="polite" aria-atomic="false"></div>

<div class="recommendation" id="recommendation" aria-live="polite" aria-atomic="true" style="display:none;"></div>

<script>
const useCustomUrlsCheckbox = document.getElementById("useCustomUrls");
const customUrlsInput = document.getElementById("customUrlsInput");
const logEl = document.getElementById("log");
const chart = document.getElementById("chart");
const ctx = chart.getContext("2d");

chart.width = chart.clientWidth * devicePixelRatio;
chart.height = chart.clientHeight * devicePixelRatio;
ctx.scale(devicePixelRatio, devicePixelRatio);

const pingPoints = [];
const downloadPoints = [];
const uploadPoints = [];
const maxPoints = 30;
let chartNeedsUpdate = false;

useCustomUrlsCheckbox.addEventListener("change", () => {
  customUrlsInput.style.display = useCustomUrlsCheckbox.checked ? "block" : "none";
});

const downloadFiles = [
  { url: "https://speed.hetzner.de/1MB.bin", sizeBytes: 1_000_000 },
  { url: "https://speed.hetzner.de/10MB.bin", sizeBytes: 10_000_000 },
  { url: "https://speed.hetzner.de/100MB.bin", sizeBytes: 100_000_000 }
];
const pingImage = "https://upload.wikimedia.org/wikipedia/commons/thumb/a/a9/Example.jpg/240px-Example.jpg";
const uploadUrl = "https://httpbin.org/post";

function drawChart() {
  if (!chartNeedsUpdate) return;
  chartNeedsUpdate = false;
  const width = chart.clientWidth;
  const height = chart.clientHeight;
  ctx.clearRect(0, 0, width, height);
  ctx.strokeStyle = "#0ff";
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(40, 10);
  ctx.lineTo(40, height - 30);
  ctx.lineTo(width - 10, height - 30);
  ctx.stroke();
  ctx.font = "12px monospace";
  ctx.fillStyle = "#0ff";
  ctx.textAlign = "center";
  ctx.fillText("Время →", width / 2, height - 8);
  ctx.save();
  ctx.translate(12, height / 2);
  ctx.rotate(-Math.PI / 2);
  ctx.fillText("Значение", 0, 0);
  ctx.restore();

  const maxVal = Math.max(...pingPoints, ...downloadPoints, ...uploadPoints, 100);
  const stepX = (width - 60) / (maxPoints - 1);

  function scaleVal(val) {
    return height - 30 - (val / maxVal) * (height - 40);
  }

  function drawLine(points, color, label) {
    ctx.strokeStyle = color;
    ctx.lineWidth = 2;
    ctx.beginPath();
    points.forEach((val, i) => {
      const x = 40 + i * stepX;
      const y = scaleVal(val);
      if (i === 0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
    });
    ctx.stroke();
    ctx.fillStyle = color;
    ctx.textAlign = "left";
    ctx.fillText(label, width - 100, 20 + 20 * ["Пинг", "Скачивание", "Загрузка"].indexOf(label));
  }

  drawLine(pingPoints, "#00ffff", "Пинг");
  drawLine(downloadPoints, "#00ff00", "Скачивание");
  drawLine(uploadPoints, "#ff8800", "Загрузка");
}

setInterval(drawChart, 100);

function log(text) {
  const now = new Date().toLocaleTimeString();
  logEl.textContent += `[${now}] ${text}\n`;
  logEl.scrollTop = logEl.scrollHeight;
}

function formatSpeed(bitsPerSecond) {
  if (!bitsPerSecond) return "0 Мбит/с";
  return bitsPerSecond >= 1e6
    ? (bitsPerSecond / 1e6).toFixed(2) + " Мбит/с"
    : (bitsPerSecond / 1e3).toFixed(2) + " Кбит/с";
}

function formatSpeedMB(bitsPerSecond) {
  return (bitsPerSecond / 8 / 1e6).toFixed(2) + " МБ/с";
}

async function getIP() {
  try {
    const res = await fetch('https://api.ipify.org?format=json');
    const data = await res.json();
    document.getElementById('ip').textContent = data.ip;
    log(`IP адрес: ${data.ip}`);
  } catch {
    document.getElementById('ip').textContent = "Ошибка";
    log(`Ошибка при получении IP`);
  }
}

async function measurePing(repeats = 5, delayMs = 250) {
  const results = [];
  for (let i = 0; i < repeats; i++) {
    const start = performance.now();
    try {
      await new Promise((resolve, reject) => {
        const img = new Image();
        img.src = pingImage + "?rand=" + Math.random();
        img.onload = resolve;
        img.onerror = reject;
      });
      const duration = performance.now() - start;
      results.push(duration);
      addPoint(pingPoints, duration);
      chartNeedsUpdate = true;
      log(`Пинг #${i + 1}: ${duration.toFixed(2)} мс`);
    } catch {
      results.push(null);
      addPoint(pingPoints, 0);
    }
    await new Promise(r => setTimeout(r, delayMs));
  }
  const valid = results.filter(r => r);
  if (!valid.length) return "ERR";
  valid.sort((a, b) => a - b);
  if (valid.length > 2) valid.splice(0, 1, valid.pop());
  return (valid.reduce((a, b) => a + b, 0) / valid.length).toFixed(2);
}

async function measureDownload() {
  let filesToDownload = useCustomUrlsCheckbox.checked
    ? customUrlsInput.value.split(/\r?\n/).map(url => ({ url, sizeBytes: 5_000_000 }))
    : downloadFiles;

  let totalBytes = 0;
  let totalTime = 0;

  for (const file of filesToDownload) {
    try {
      const url = file.url + (file.url.includes("?") ? "&" : "?") + "rand=" + Math.random();
      const start = performance.now();
      const res = await fetch(url, { cache: "no-cache" });
      await res.blob();
      const end = performance.now();
      const time = (end - start) / 1000;
      totalBytes += file.sizeBytes;
      totalTime += time;
      const speed = (totalBytes * 8) / totalTime;
      addPoint(downloadPoints, speed / 1e6);
      chartNeedsUpdate = true;
      log(`Скачано ${file.sizeBytes / 1e6} МБ за ${time.toFixed(2)} сек`);
    } catch (e) {
      log("Ошибка при скачивании: " + e.message);
    }
  }

  if (!totalTime) return 0;
  return (totalBytes * 8) / totalTime;
}

async function measureUpload() {
  const size = 512 * 1024;
  const data = new Uint8Array(size);
  const start = performance.now();
  await fetch(uploadUrl, { method: "POST", body: data });
  const time = (performance.now() - start) / 1000;
  const speed = (size * 8) / time;
  addPoint(uploadPoints, speed / 1e6);
  chartNeedsUpdate = true;
  return speed;
}

function addPoint(arr, val) {
  if (arr.length >= maxPoints) arr.shift();
  arr.push(val);
}

function generateRecommendation(ping, dl, ul) {
  return `Пинг: ${ping} мс<br>Скачивание: ${formatSpeed(dl)}<br>Загрузка: ${formatSpeed(ul)}<br>`;
}

async function startTest() {
  logEl.textContent = "";
  document.getElementById("startBtn").disabled = true;
  await getIP();
  const ping = await measurePing();
  document.getElementById("ping").textContent = ping === "ERR" ? "Ошибка" : ping + " мс";
  const dl = await measureDownload();
  document.getElementById("download").textContent = formatSpeed(dl);
  document.getElementById("speed").textContent = (dl / 1e6).toFixed(2);
  document.getElementById("speed-mb").textContent = formatSpeedMB(dl);
  const ul = await measureUpload();
  document.getElementById("upload").textContent = formatSpeed(ul);
  const rec = document.getElementById("recommendation");
  rec.innerHTML = generateRecommendation(ping, dl, ul);
  rec.style.display = "block";
  document.getElementById("startBtn").disabled = false;
  log("Тест завершён.");
}

function toggleIP() {
  const ip = document.getElementById("ip");
  const btn = document.getElementById("toggleIpBtn");
  if (ip.textContent === "…") return;
  if (ip.style.userSelect === "none") {
    ip.textContent = ip.dataset.ip;
    ip.style.userSelect = "text";
    btn.textContent = "Скрыть IP";
  } else {
    ip.dataset.ip = ip.textContent;
    ip.textContent = ip.textContent.replace(/./g, "*");
    ip.style.userSelect = "none";
    btn.textContent = "Показать IP";
  }
}
</script>
</body>
</html>
