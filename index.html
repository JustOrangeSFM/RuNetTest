<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>RuNetTest — Проверка интернет-соединения</title>
<style>
  body {
    background: #0d1117;
    color: #eee;
    font-family: Arial, sans-serif;
    text-align: center;
    padding: 40px 20px 60px;
    margin: 0;
  }
  h1 {
    margin-bottom: 10px;
  }
  .circle {
    width: 220px;
    height: 220px;
    background: radial-gradient(#111, #000);
    border: 8px solid #333;
    border-radius: 50%;
    margin: 20px auto;
    box-shadow: 0 0 15px #0ff;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
  }
  .value {
    font-size: 3em;
    color: #0ff;
    font-weight: bold;
  }
  .unit {
    font-size: 1.1em;
    color: #888;
    margin-top: 4px;
  }
  .results {
    margin-top: 30px;
    font-size: 1.25em;
    line-height: 1.8em;
    max-width: 480px;
    margin-left: auto;
    margin-right: auto;
    text-align: left;
  }
  .results div {
    margin-bottom: 10px;
  }
  .recommendation {
    margin-top: 30px;
    background: #111;
    padding: 20px;
    max-width: 480px;
    margin-left: auto;
    margin-right: auto;
    border-radius: 10px;
    color: #0ff;
    font-size: 1.1em;
    line-height: 1.5em;
  }
  button {
    margin-top: 35px;
    padding: 12px 40px;
    font-size: 1.2em;
    background: #0ff;
    border: none;
    border-radius: 6px;
    color: #000;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  button:hover:not(:disabled) {
    background: #00cccc;
  }
  button:disabled {
    background: #055757;
    cursor: not-allowed;
  }
  #toggleIpBtn {
    font-size: 0.8em;
    padding: 4px 8px;
    margin-left: 10px;
    vertical-align: middle;
    cursor: pointer;
    border-radius: 4px;
    background: #0ff;
    color: #000;
    border: none;
    transition: background-color 0.3s ease;
  }
  #toggleIpBtn:hover:not(:disabled) {
    background: #00cccc;
  }
  canvas {
    margin: 20px auto;
    display: block;
    background: #111;
    border-radius: 8px;
    max-width: 480px;
    width: 100%;
    height: 180px;
  }
  #log {
    max-width: 480px;
    margin: 10px auto 0;
    padding: 15px;
    background: #111;
    border-radius: 8px;
    height: 140px;
    overflow-y: auto;
    font-size: 0.9em;
    color: #0ff;
    font-family: monospace;
    text-align: left;
    white-space: pre-wrap;
  }
  .speed-mb {
    font-size: 0.9em;
    color: #0aa;
    margin-top: 2px;
  }
</style>
</head>
<body>

<h1>RuNetTest — Проверка интернет-соединения</h1>

<div class="circle" aria-live="polite" aria-atomic="true">
  <div class="value" id="speed">0</div>
  <div class="unit" id="speed-unit">Мбит/с</div>
  <div class="speed-mb" id="speed-mb"></div>
</div>

<div class="results" aria-live="polite" aria-atomic="true">
  <div>
    <strong>Ваш IP:</strong> 
    <span id="ip">…</span>
    <button id="toggleIpBtn" onclick="toggleIP()">Скрыть IP</button>
  </div>
  <div><strong>Пинг (задержка):</strong> <span id="ping">…</span></div>
  <div><strong>Скорость скачивания (download):</strong> <span id="download">…</span></div>
  <div><strong>Скорость отправки данных (upload):</strong> <span id="upload">…</span></div>
</div>

<button id="startBtn" onclick="startTest()">Начать тест</button>

<canvas id="chart" aria-label="График скорости и пинга" role="img"></canvas>

<div id="log" aria-live="polite" aria-atomic="false"></div>

<div class="recommendation" id="recommendation" aria-live="polite" aria-atomic="true" style="display:none;"></div>

<script>
  const logEl = document.getElementById("log");
  const chart = document.getElementById("chart");
  const ctx = chart.getContext("2d");

  chart.width = chart.clientWidth * devicePixelRatio;
  chart.height = chart.clientHeight * devicePixelRatio;
  ctx.scale(devicePixelRatio, devicePixelRatio);

  const pingPoints = [];
  const downloadPoints = [];
  const uploadPoints = [];
  const maxPoints = 30;

  let chartNeedsUpdate = false;
  let isRunning = false;

  function log(text) {
    const now = new Date().toLocaleTimeString();
    logEl.textContent += `[${now}] ${text}\n`;
    logEl.scrollTop = logEl.scrollHeight;
  }

  function formatSpeed(bitsPerSecond) {
    if (typeof bitsPerSecond !== "number" || bitsPerSecond <= 0) return "0 Мбит/с";
    if (bitsPerSecond >= 1e9) return (bitsPerSecond / 1e9).toFixed(2) + " Гбит/с";
    if (bitsPerSecond >= 1e6) return (bitsPerSecond / 1e6).toFixed(2) + " Мбит/с";
    if (bitsPerSecond >= 1e3) return (bitsPerSecond / 1e3).toFixed(2) + " Кбит/с";
    return bitsPerSecond.toFixed(2) + " бит/с";
  }

  function formatSpeedMB(bitsPerSecond) {
    if (typeof bitsPerSecond !== "number" || bitsPerSecond <= 0) return "0 МБ/с";
    const bytesPerSecond = bitsPerSecond / 8;
    if (bytesPerSecond >= 1e6) return (bytesPerSecond / 1e6).toFixed(2) + " МБ/с";
    if (bytesPerSecond >= 1e3) return (bytesPerSecond / 1e3).toFixed(2) + " КБ/с";
    return bytesPerSecond.toFixed(2) + " Б/с";
  }

  async function getIP() {
    try {
      const res = await fetch('https://api64.ipify.org?format=json');
      const data = await res.json();
      document.getElementById('ip').textContent = data.ip;
      log(`IP адрес получен`);
    } catch {
      document.getElementById('ip').textContent = "Не удалось получить IP";
      log(`Ошибка при получении IP`);
    }
  }

  const pingUrls = [
    "https://www.google.com/generate_204",
    "https://cloudflare.com/cdn-cgi/trace",
    "https://1.1.1.1/cdn-cgi/trace"
  ];

  async function measurePing(repeats = 7, delayMs = 150) {
    let results = [];

    for (let i = 0; i < repeats; i++) {
      const url = pingUrls[i % pingUrls.length] + "?rand=" + Math.random();

      const start = performance.now();
      try {
        await fetch(url, { method: "HEAD", mode: "no-cors" });
        const duration = performance.now() - start;
        results.push(duration);
        addPoint(pingPoints, duration);
        chartNeedsUpdate = true;
        log(`Пинг #${i + 1}: ${duration.toFixed(2)} мс`);
      } catch {
        results.push(null);
        addPoint(pingPoints, 0);
        chartNeedsUpdate = true;
        log(`Пинг #${i + 1}: ошибка`);
      }
      await new Promise(r => setTimeout(r, delayMs));
    }

    const valid = results.filter(r => typeof r === "number" && r > 0);
    if (valid.length === 0) return "ERR";
    valid.sort((a, b) => a - b);
    if (valid.length > 2) {
      valid.splice(0, 1);
      valid.splice(valid.length - 1, 1);
    }
    const avg = valid.reduce((a, b) => a + b, 0) / valid.length;
    return avg.toFixed(2);
  }

  // Используем CORS-дружелюбные файлы для скачивания
  const downloadFiles = [
    { url: "https://speed.hetzner.de/5MB.bin", sizeBytes: 5 * 1024 * 1024 },
    { url: "https://speed.hetzner.de/10MB.bin", sizeBytes: 10 * 1024 * 1024 }
  ];

  // Тест загрузки отключён (нет CORS-доступного URL)
  async function measureUpload() {
    log("Тест загрузки временно отключен из-за ограничений CORS.");
    return 0;
  }

  async function measureDownload() {
    let totalBytes = 0;
    let totalTime = 0;

    for (const file of downloadFiles) {
      const url = file.url + (file.url.includes("?") ? "&" : "?") + "rand=" + Math.random();
      log(`Скачиваем файл (примерно ${(file.sizeBytes / (1024 * 1024)).toFixed(2)} МБ): ${file.url}`);
      const start = performance.now();
      try {
        const response = await fetch(url, { cache: "no-cache" });
        if (!response.ok) throw new Error("HTTP " + response.status);
        await response.blob();
        const end = performance.now();

        totalBytes += file.sizeBytes;
        totalTime += (end - start) / 1000;

        const speed = (totalBytes * 8) / totalTime;
        addPoint(downloadPoints, speed / 1e6);
        chartNeedsUpdate = true;

        log(`Скачано ${(totalBytes / (1024 * 1024)).toFixed(2)} МБ за ${totalTime.toFixed(2)} сек, скорость: ${formatSpeed(speed)}`);
      } catch (e) {
        log(`Ошибка при скачивании: ${e.message}`);
      }
    }
    if (totalTime === 0) return 0;
    return (totalBytes * 8) / totalTime;
  }

  function addPoint(arr, val) {
    if (arr.length >= maxPoints) arr.shift();
    arr.push(val);
  }

  function updateResults(speedBitsPerSec, pingMs, downloadBps, uploadBps) {
    document.getElementById("speed").textContent = (speedBitsPerSec / 1e6).toFixed(2);
    document.getElementById("speed-unit").textContent = "Мбит/с";
    document.getElementById("speed-mb").textContent = formatSpeedMB(speedBitsPerSec);

    document.getElementById("ping").textContent = pingMs ? pingMs + " мс" : "—";
    document.getElementById("download").textContent = downloadBps ? formatSpeed(downloadBps) : "—";
    document.getElementById("upload").textContent = uploadBps ? formatSpeed(uploadBps) : "—";
  }

  function drawChart() {
    if (!chartNeedsUpdate) return;
    chartNeedsUpdate = false;

    const width = chart.clientWidth;
    const height = chart.clientHeight;
    ctx.clearRect(0, 0, width, height);

    ctx.strokeStyle = "#0ff";
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(40, 10);
    ctx.lineTo(40, height - 30);
    ctx.lineTo(width - 10, height - 30);
    ctx.stroke();

    ctx.font = "12px monospace";
    ctx.fillStyle = "#0ff";
    ctx.textAlign = "center";

    ctx.fillText("Время →", width / 2, height - 8);
    ctx.save();
    ctx.translate(12, height / 2);
    ctx.rotate(-Math.PI / 2);
    ctx.fillText("Значение", 0, 0);
    ctx.restore();

    const maxPing = Math.max(...pingPoints, 0);
    const maxDownload = Math.max(...downloadPoints, 0);
    const maxUpload = Math.max(...uploadPoints, 0);
    let maxVal = Math.max(maxPing, maxDownload, maxUpload, 100);
    if (maxVal < 10) maxVal = 10;

    const stepX = (width - 60) / (maxPoints - 1);

    function scaleVal(val) {
      return height - 30 - (val / maxVal) * (height - 40);
    }

    function drawLine(points, color, label) {
      ctx.strokeStyle = color;
      ctx.lineWidth = 2;
      ctx.beginPath();
      points.forEach((val, i) => {
        const x = 40 + i * stepX;
        const y = scaleVal(val);
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.stroke();

      ctx.fillStyle = color;
      ctx.textAlign = "left";
      ctx.fillText(label, width - 100, 20 + 20 * ["Пинг", "Скачивание", "Загрузка"].indexOf(label));
    }

    drawLine(pingPoints, "#00ffff", "Пинг");
    drawLine(downloadPoints, "#00ff00", "Скачивание");
    drawLine(uploadPoints, "#ff8800", "Загрузка");
  }

  setInterval(drawChart, 100);

  async function startTest() {
    if (isRunning) return;
    isRunning = true;
    logEl.textContent = "";
    updateResults(0, null, 0, 0);

    log("ВНИМАНИЕ: Запускайте файл через HTTPS-хостинг (например, GitHub Pages) или локальный HTTP-сервер для корректной работы.");

    await getIP();

    let pingResult = await measurePing();
    if (pingResult === "ERR") {
      log("Все попытки пинга не удались");
      pingResult = null;
    }

    let downloadResult = await measureDownload();
    let uploadResult = await measureUpload();

    updateResults(downloadResult, pingResult, downloadResult, uploadResult);

    isRunning = false;
  }

  function toggleIP() {
    const ipEl = document.getElementById("ip");
    const btn = document.getElementById("toggleIpBtn");
    if (ipEl.textContent === "Скрыт") {
      getIP();
      btn.textContent = "Скрыть IP";
    } else {
      ipEl.textContent = "Скрыт";
      btn.textContent = "Показать IP";
    }
  }
</script>

</body>
</html>
